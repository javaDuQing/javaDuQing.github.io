(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{482:function(t,e,_){"use strict";_.r(e);var v=_(2),a=Object(v.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("blockquote",[e("p",[t._v("本文主要内容来自："),e("a",{attrs:{href:"https://coding.imooc.com/class/151.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("《一站式学习Redis从入门到高可用分布式实践》"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"_1-redis总览"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis总览"}},[t._v("#")]),t._v(" 1 Redis总览")]),t._v(" "),e("h3",{attrs:{id:"_1-1-特性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-特性"}},[t._v("#")]),t._v(" 1.1 特性")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610983515317-495100eb-38e9-4c5c-869d-ce82d78afd4c.png#height=300&id=X3zEb&name=1.png&originHeight=300&originWidth=982&originalType=binary&ratio=1&size=89462&status=done&style=none&width=982",alt:"1.png"}})]),t._v(" "),e("h3",{attrs:{id:"_1-2-应用场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-应用场景"}},[t._v("#")]),t._v(" 1.2 应用场景")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1611025793071-35f298d0-c621-42b3-aebe-7c1d3227d684.png#height=247&id=R7fnE&name=DD1B0D87-B526-4F31-B947-43F0F664C2C1.png&originHeight=247&originWidth=1261&originalType=binary&ratio=1&size=74763&status=done&style=none&width=1261",alt:"DD1B0D87-B526-4F31-B947-43F0F664C2C1.png"}})]),t._v(" "),e("h2",{attrs:{id:"_2-数据结构简单介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据结构简单介绍"}},[t._v("#")]),t._v(" 2 数据结构简单介绍")]),t._v(" "),e("p",[t._v("使用 redis 3.0 版本")]),t._v(" "),e("h3",{attrs:{id:"_2-1-安装与启动"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-安装与启动"}},[t._v("#")]),t._v(" 2.1 安装与启动")]),t._v(" "),e("h4",{attrs:{id:"_2-1-1-安装目录文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-安装目录文件"}},[t._v("#")]),t._v(" 2.1.1 安装目录文件")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610983604979-60d8f1e4-80d6-4285-a064-16077e580b72.png#height=255&id=LeWCZ&name=3.png&originHeight=255&originWidth=410&originalType=binary&ratio=1&size=39687&status=done&style=none&width=410",alt:"3.png"}})]),t._v(" "),e("h4",{attrs:{id:"_2-1-2-server-三种启动方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-server-三种启动方式"}},[t._v("#")]),t._v(" 2.1.2 server 三种启动方式")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("序号")])]),t._v(" "),e("th",[e("strong",[t._v("方式")])]),t._v(" "),e("th",[e("strong",[t._v("说明")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("1")]),t._v(" "),e("td",[t._v("执行命令：redis-server")]),t._v(" "),e("td",[t._v("最简启动")])]),t._v(" "),e("tr",[e("td",[t._v("2")]),t._v(" "),e("td",[t._v("执行命令：redis-server --port 6380")]),t._v(" "),e("td",[t._v("动态参数启动")])]),t._v(" "),e("tr",[e("td",[t._v("3")]),t._v(" "),e("td",[t._v("执行命令：redis-server configPath")]),t._v(" "),e("td",[t._v("配置参数启动")])])])]),t._v(" "),e("h4",{attrs:{id:"_2-1-3-客户端连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-客户端连接"}},[t._v("#")]),t._v(" 2.1.3 客户端连接")]),t._v(" "),e("p",[t._v("redis-cli -h [ip] -p [port]\n连上之后就可以执行各种操作了")]),t._v(" "),e("h4",{attrs:{id:"_2-1-4-常用配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-4-常用配置"}},[t._v("#")]),t._v(" 2.1.4 常用配置")]),t._v(" "),e("ul",[e("li",[t._v("port：端口（默认6379）")]),t._v(" "),e("li",[t._v("logfile：日志文件名称，只是一个文件名")]),t._v(" "),e("li",[t._v("dir：Redis的工作目录，logfile、aof等存放的路径")]),t._v(" "),e("li",[t._v("RDB config、AOF config、slow Log config、maxMemory等等")])]),t._v(" "),e("h3",{attrs:{id:"_2-2-数据结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-数据结构"}},[t._v("#")]),t._v(" 2.2 数据结构")]),t._v(" "),e("h4",{attrs:{id:"_2-2-1-通用命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-通用命令"}},[t._v("#")]),t._v(" 2.2.1 通用命令")]),t._v(" "),e("ol",[e("li",[t._v("keys [pattern]：返回redis中所有的key\n"),e("ol",[e("li",[t._v("keys he*：返回he开头的key")])])]),t._v(" "),e("li",[t._v("dbsize：返回redis中key-value的数量")]),t._v(" "),e("li",[t._v("exists key：key是否存在")]),t._v(" "),e("li",[t._v("del key：删除key，可以删除多个del key1 key2...")]),t._v(" "),e("li",[t._v("过期时间：\n"),e("ol",[e("li",[t._v("expire key seconds：设置key的过期时间")]),t._v(" "),e("li",[t._v("ttl key：查看key剩余时间")]),t._v(" "),e("li",[t._v("persist key：去掉过期时间")])])]),t._v(" "),e("li",[t._v("type key：查看key的数据类型")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("时间复杂度")])]),t._v(" "),e("th",[e("strong",[t._v("说明")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("keys")]),t._v(" "),e("td",[t._v("O(n)")]),t._v(" "),e("td",[t._v("扫描全表，不建议生产环境使用")])]),t._v(" "),e("tr",[e("td",[t._v("dbsize")]),t._v(" "),e("td",[t._v("O(1)")]),t._v(" "),e("td",[t._v("redis内部维护一个计数器")])]),t._v(" "),e("tr",[e("td",[t._v("del")]),t._v(" "),e("td",[t._v("O(1)")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("exists")]),t._v(" "),e("td",[t._v("O(1)")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("expire")]),t._v(" "),e("td",[t._v("O(1)")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("type")]),t._v(" "),e("td",[t._v("O(1)")]),t._v(" "),e("td")])])]),t._v(" "),e("h4",{attrs:{id:"_2-2-2-数据结构和内部编码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-数据结构和内部编码"}},[t._v("#")]),t._v(" 2.2.2 数据结构和内部编码")]),t._v(" "),e("p",[t._v("row:[rɔː]")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610983777803-97693596-6f45-47a2-a9f4-57a3790dd945.png#height=315&id=LIFh1&name=4.png&originHeight=315&originWidth=325&originalType=binary&ratio=1&size=30540&status=done&style=none&width=325",alt:"4.png"}})]),t._v(" "),e("h4",{attrs:{id:"_2-2-3-单线程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-单线程"}},[t._v("#")]),t._v(" 2.2.3 单线程")]),t._v(" "),e("ol",[e("li",[t._v("一次只运行一条命令")]),t._v(" "),e("li",[t._v("拒绝长（慢）命令：keys,flush all,flushdb，会堵住后面的命令")]),t._v(" "),e("li",[t._v("有些功能不是单线程：fysnc file descriptor")])]),t._v(" "),e("p",[t._v("为什么这么快？")]),t._v(" "),e("ol",[e("li",[t._v("纯内存")]),t._v(" "),e("li",[t._v("非阻塞IO，select/poll/epoll")]),t._v(" "),e("li",[t._v("单线程优势：避免线程切换和静态消耗")])]),t._v(" "),e("h4",{attrs:{id:"_2-2-4-基本数据结构一-字符串"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-4-基本数据结构一-字符串"}},[t._v("#")]),t._v(" 2.2.4 基本数据结构一：字符串")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/375413/1677034552812-5e2cb85f-20b1-4939-b26e-53697aba30e1.png#averageHue=%23f5ea95&clientId=uad6b681b-275a-4&from=paste&height=294&id=u2d1312a9&name=image.png&originHeight=588&originWidth=1510&originalType=binary&ratio=2&rotation=0&showTitle=false&size=240820&status=done&style=none&taskId=ue50b576b-684e-4dfd-b5b1-7e0c6992173&title=&width=755",alt:"image.png"}})]),t._v(" "),e("p",[t._v("mgset和mset的优点：\n"),e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610983852790-7ce8e5a8-436a-4825-8290-3a09fe9ea65c.png#height=198&id=Fqyxv&name=5.png&originHeight=434&originWidth=996&originalType=binary&ratio=1&size=36470&status=done&style=none&width=454",alt:"5.png"}}),t._v("\n1次mget = 1次网络时间 + n次命令时间")]),t._v(" "),e("p",[t._v("应用：")]),t._v(" "),e("ol",[e("li",[e("strong",[t._v("某个人主页被访问次数")]),t._v("，key = userid:pageview；incr userid:pageview（单线程、无并发问题）")]),t._v(" "),e("li",[e("strong",[t._v("分布式Id")])]),t._v(" "),e("li",[e("strong",[t._v("incr id")])])]),t._v(" "),e("h4",{attrs:{id:"_2-2-5-基本数据结构二-哈希-命令以h开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-5-基本数据结构二-哈希-命令以h开头"}},[t._v("#")]),t._v(" 2.2.5 基本数据结构二：哈希(命令以h开头)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610983900329-61611534-271b-4baf-8bb7-35d0acfd64cb.png#height=246&id=CSevG&name=6.png&originHeight=532&originWidth=832&originalType=binary&ratio=1&size=51603&status=done&style=none&width=384",alt:"6.png"}})]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])]),t._v(" "),e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("hget key field")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("hmset key field1 value1 field2 value2...")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("hget set fileld value")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("hvalues key")]),t._v(" "),e("td",[t._v("返回这个key对应的所有value")])]),t._v(" "),e("tr",[e("td",[t._v("hdel key field")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("hkeys key")]),t._v(" "),e("td",[t._v("返回这个key对应的所有field")])]),t._v(" "),e("tr",[e("td",[t._v("hexists key field")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("hgetall key")]),t._v(" "),e("td",[t._v("返回这个key对应的所有field和value")])]),t._v(" "),e("tr",[e("td",[t._v("hlen key")]),t._v(" "),e("td",[t._v("key的field总数")]),t._v(" "),e("td",[t._v("hsetnx key field value")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("hmget key field1 field2...")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("...")]),t._v(" "),e("td")])])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("优点")])]),t._v(" "),e("th",[e("strong",[t._v("缺点")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("String key json")]),t._v(" "),e("td",[t._v("编程简单")]),t._v(" "),e("td",[t._v("序列化开销；设置属性要操作整个数据")])]),t._v(" "),e("tr",[e("td",[t._v("hash")]),t._v(" "),e("td",[t._v("直观；可以部分更新")]),t._v(" "),e("td",[t._v("编程稍微复杂；ttl不好控制")])])])]),t._v(" "),e("h4",{attrs:{id:"_2-2-6-基本数据结构三-列表list-命令以l开头"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-6-基本数据结构三-列表list-命令以l开头"}},[t._v("#")]),t._v(" 2.2.6 基本数据结构三：列表list(命令以l开头)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984013196-9ee297eb-7e21-4be1-a292-057657899d1b.png#height=50&id=SS3ae&name=7.png&originHeight=80&originWidth=890&originalType=binary&ratio=1&size=12104&status=done&style=none&width=551",alt:"7.png"}})]),t._v(" "),e("p",[t._v("特点：有序、可以重复、支持左右操作")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])]),t._v(" "),e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("rpush key value1 value2 ...")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("ltrim key startIndex endIndex")]),t._v(" "),e("td",[t._v("让列表只保留指定区间内的元素，不在指定区间之内的元素都将被删除")])]),t._v(" "),e("tr",[e("td",[t._v("lpush key value1 value2 ...")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("lrange key startIndex endIndex")]),t._v(" "),e("td",[t._v("获取列表指定索引范围所有项目 "),e("br"),t._v("1. lrange key 0 2：[0,2]，包含end "),e("br"),t._v("2. lrange key 1 -1：[1,∞）")])]),t._v(" "),e("tr",[e("td",[t._v("linsert key before|after value newValue")]),t._v(" "),e("td",[t._v("在list指定的值前|后插入newValue")]),t._v(" "),e("td",[t._v("lindex key index")]),t._v(" "),e("td",[t._v("按照索引取值")])]),t._v(" "),e("tr",[e("td",[t._v("lpop key")]),t._v(" "),e("td",[t._v("从左边弹出一个")]),t._v(" "),e("td",[t._v("llen key")]),t._v(" "),e("td",[t._v("获取列表长度")])]),t._v(" "),e("tr",[e("td",[t._v("rpop key")]),t._v(" "),e("td"),t._v(" "),e("td",[t._v("lset key index newValue")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("lrem key count value")]),t._v(" "),e("td",[t._v("根据count值，从列表中删除所有value相等的项："),e("br"),t._v("1. count>0，从左到右，删除最多count个value相等的项 "),e("br"),t._v("2. count<0，从右到左，删除最多abs(count)个value相等的项 "),e("br"),t._v("3. count = 0，删除所有value相等的项")]),t._v(" "),e("td",[t._v("blpop/brpop，lpop/rpop的阻塞版本")]),t._v(" "),e("td",[t._v("取不到数据就阻塞等待，用于生产者和消费者模型")])])])]),t._v(" "),e("p",[t._v("应用：微博的TimeLine，查看所有关注的人的动态，按照时间倒序\n当关注的人发了动态，就使用lpush插入到你的timeline中")]),t._v(" "),e("h4",{attrs:{id:"_2-2-7-基本数据结构四-set-命令以s开头-集合"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-7-基本数据结构四-set-命令以s开头-集合"}},[t._v("#")]),t._v(" 2.2.7 基本数据结构四：set(命令以s开头，集合)")]),t._v(" "),e("p",[t._v("特性：value不能有重复元素、无序、支持集合之间的操作\n"),e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984130016-6fac2f83-56cb-4cc7-892d-7a6a0190cfbe.png#height=252&id=GeNpQ&name=8.png&originHeight=404&originWidth=614&originalType=binary&ratio=1&size=25466&status=done&style=none&width=383",alt:"8.png"}})]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])]),t._v(" "),e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("sadd key element")]),t._v(" "),e("td",[t._v("向集合key添加element，如果存在，添加失败")]),t._v(" "),e("td",[t._v("spop key")]),t._v(" "),e("td",[t._v("从集合中弹出一个元素")])]),t._v(" "),e("tr",[e("td",[t._v("srem key element")]),t._v(" "),e("td",[t._v("删除集合key中的element元素")]),t._v(" "),e("td",[t._v("sdiff key1 key2")]),t._v(" "),e("td",[t._v("差集")])]),t._v(" "),e("tr",[e("td",[t._v("scard key")]),t._v(" "),e("td",[t._v("计算集合大小")]),t._v(" "),e("td",[t._v("sinter key1 key2")]),t._v(" "),e("td",[t._v("交集")])]),t._v(" "),e("tr",[e("td",[t._v("sismember key element")]),t._v(" "),e("td",[t._v("判断元素element是否在集合中")]),t._v(" "),e("td",[t._v("sunion key1 key2")]),t._v(" "),e("td",[t._v("并集")])]),t._v(" "),e("tr",[e("td",[t._v("srandmember key count")]),t._v(" "),e("td",[t._v("随机从集合中挑count个元素")]),t._v(" "),e("td"),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("smembers key")]),t._v(" "),e("td",[t._v("取出集合中所有元素")]),t._v(" "),e("td"),t._v(" "),e("td")])])]),t._v(" "),e("p",[t._v("应用：")]),t._v(" "),e("ul",[e("li",[t._v("微博的关注，每关注一个，就放一个到value中；")]),t._v(" "),e("li",[t._v("共同关注：可以计算出两个user的共同关注sinter方法")]),t._v(" "),e("li",[t._v("微博抽奖：如果是可以重复抽奖可以使用srandmember，不可重复抽可以使用spop")]),t._v(" "),e("li",[t._v("一条微博有哪些人like、赞、踩，可以使用集合记录")])]),t._v(" "),e("h4",{attrs:{id:"_2-2-8-基本数据结构五-zset-命令以z开头-有序集合"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-8-基本数据结构五-zset-命令以z开头-有序集合"}},[t._v("#")]),t._v(" 2.2.8 基本数据结构五：zset(命令以z开头，有序集合)")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984189985-d365f69f-a0f8-4c10-b1d9-3dc689100e72.png#height=182&id=Ljn6h&name=9.png&originHeight=338&originWidth=836&originalType=binary&ratio=1&size=31142&status=done&style=none&width=450",alt:"9.png"}})]),t._v(" "),e("p",[t._v("集合（set） vs 有序集合（zset）")]),t._v(" "),e("ol",[e("li",[t._v("均无重复元素（zset, score能重复，element不能重复）")]),t._v(" "),e("li",[t._v("set无序，zset有序")]),t._v(" "),e("li",[t._v("set只有element，zset有element + score")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])]),t._v(" "),e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("含义")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("zadd key score element")]),t._v(" "),e("td",[t._v("向集合key添加score,element")]),t._v(" "),e("td",[t._v("zrangebyscore key score1 score2")]),t._v(" "),e("td",[t._v("返回指定分数范围的element")])]),t._v(" "),e("tr",[e("td",[t._v("zrem key element")]),t._v(" "),e("td",[t._v("删除集合key中的element元素")]),t._v(" "),e("td",[t._v("zcount key score1 score2")]),t._v(" "),e("td",[t._v("返回指定分数范围的element个数")])]),t._v(" "),e("tr",[e("td",[t._v("zscore key element")]),t._v(" "),e("td",[t._v("获取element的score")]),t._v(" "),e("td",[t._v("zremrangebyrank key index1 index2")]),t._v(" "),e("td",[t._v("按照排名范围删除element")])]),t._v(" "),e("tr",[e("td",[t._v("zincrby key increScore element")]),t._v(" "),e("td",[t._v("给element增加分数")]),t._v(" "),e("td",[t._v("zremrangebyscore key score1 score2")]),t._v(" "),e("td",[t._v("按照分数范围删除element")])]),t._v(" "),e("tr",[e("td",[t._v("zcard key")]),t._v(" "),e("td",[t._v("返回element的个数")]),t._v(" "),e("td",[t._v("zinter、zunion、zdiff")]),t._v(" "),e("td")]),t._v(" "),e("tr",[e("td",[t._v("zrange key index1 index2")]),t._v(" "),e("td",[t._v("返回指定索引范围的element")]),t._v(" "),e("td"),t._v(" "),e("td")])])]),t._v(" "),e("p",[t._v("应用：微博热搜榜，每看过一次分数加1")]),t._v(" "),e("h3",{attrs:{id:"_2-3-扩展功能"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-扩展功能"}},[t._v("#")]),t._v(" 2.3 扩展功能")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984284581-00643310-bdab-4e83-85a7-39dcb2135cca.png#height=210&id=jzXhG&name=10.png&originHeight=210&originWidth=710&originalType=binary&ratio=1&size=16655&status=done&style=none&width=710",alt:"10.png"}})]),t._v(" "),e("h4",{attrs:{id:"_2-3-1-慢查询日志"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-慢查询日志"}},[t._v("#")]),t._v(" 2.3.1 慢查询日志")]),t._v(" "),e("p",[t._v("redis可以记录执行时间超过某个时长的命令，使用先进先出的队列保存，这个队列固定长度，且是保存在内存中 ；最好是一段时间持久化一次慢查询，因为超过慢查询队列长度，先进的慢查询就会被删除")]),t._v(" "),e("p",[t._v("配置：")]),t._v(" "),e("ol",[e("li",[t._v("slowlog-max-len：慢查询队列长度，默认是128")]),t._v(" "),e("li",[t._v("slowlog-log-slower-than：慢查询日志阈值（微妙，1毫秒 = 1000微妙），默认是10 000 = 10毫秒\n"),e("ol",[e("li",[t._v("设置0，记录所有命令")]),t._v(" "),e("li",[t._v("设置小于0，不记录任何命令")]),t._v(" "),e("li",[t._v("建议设置成1毫秒（redis通常的qps最少是10000/1秒，每条命令平均0.1毫秒）")])])])]),t._v(" "),e("p",[t._v("方法：1. 修改配置文件重启；2. 动态配置：config set ...")]),t._v(" "),e("p",[t._v("相关命令：")]),t._v(" "),e("ol",[e("li",[t._v("slowlog get n ：获取n条慢查询")]),t._v(" "),e("li",[t._v("slowlog len：获取慢查询队列有多少个慢查询")]),t._v(" "),e("li",[t._v("slowlog reset：清空慢查询")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984336539-4d158afa-5fcb-4d57-af28-0dcd897cdec3.png#height=194&id=FHRqQ&name=11.png&originHeight=194&originWidth=681&originalType=binary&ratio=1&size=21120&status=done&style=none&width=681",alt:"11.png"}})]),t._v(" "),e("h4",{attrs:{id:"_2-3-2-pipeline-批量操作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-pipeline-批量操作"}},[t._v("#")]),t._v(" 2.3.2 pipeline（批量操作）")]),t._v(" "),e("p",[t._v("redis每条命令的执行时间平均0.1毫秒，这样的话网络就成为了瓶颈")]),t._v(" "),e("ul",[e("li",[t._v("N个命令操作：n次网络 + n次命令")]),t._v(" "),e("li",[t._v("1次pipeline：1次网络 + n次命令")])]),t._v(" "),e("p",[t._v("jedis写法：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Jedis")]),t._v(" jedis "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Jedis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Pipeline")]),t._v(" pipeline "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipelined")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" j "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" j "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        pipeline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("hset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hashkey"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" j"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"field"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" j"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" j"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    pipeline"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("syncAndReturnAll")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("与mget、mset的区别：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984385931-81843c3a-15e5-4b17-9577-ca8256c871a4.png#height=206&id=ythof&name=12.png&originHeight=206&originWidth=461&originalType=binary&ratio=1&size=10098&status=done&style=none&width=461",alt:"12.png"}})]),t._v(" "),e("p",[t._v("pipeline命令不是原子的")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984439561-52302740-2944-4746-a5ac-1fb15c9a09db.png#height=211&id=T7gxK&name=13.png&originHeight=211&originWidth=594&originalType=binary&ratio=1&size=12909&status=done&style=none&width=594",alt:"13.png"}})]),t._v(" "),e("h4",{attrs:{id:"_2-3-3-发布订阅"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-3-发布订阅"}},[t._v("#")]),t._v(" 2.3.3 发布订阅")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984465765-61f3b7fe-1bed-4cb9-82d4-ebfd1881396f.png#height=304&id=r3d58&name=14.png&originHeight=304&originWidth=522&originalType=binary&ratio=1&size=25487&status=done&style=none&width=522",alt:"14.png"}})]),t._v(" "),e("p",[t._v("注意和消息队列模型的区别：发布订阅是每个订阅者都能收到，消息队列是每个消息只能被一个消费者消费")]),t._v(" "),e("p",[t._v("命令：")]),t._v(" "),e("ol",[e("li",[t._v('publish channel message：publish sohu:tv "hello world"')]),t._v(" "),e("li",[t._v("subscribe channel：subscribe sohu:tv")]),t._v(" "),e("li",[t._v("unsubscribe channel")])]),t._v(" "),e("h4",{attrs:{id:"_2-3-4-bitmap-位图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-4-bitmap-位图"}},[t._v("#")]),t._v(" 2.3.4 bitMap（位图）")]),t._v(" "),e("p",[t._v("bitmap底层是字符串类型，所以value最大为512M")]),t._v(" "),e("p",[t._v("字符串big对应的二进制：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984514438-7f2b6f92-2235-4800-85dc-dda8a43825f4.png#height=110&id=ZB0ah&name=15.png&originHeight=110&originWidth=696&originalType=binary&ratio=1&size=11944&status=done&style=none&width=696",alt:"15.png"}})]),t._v(" "),e("p",[t._v("命令：")]),t._v(" "),e("ol",[e("li",[t._v("setbit key offset 0/1：把key对于的value的第offset为修改为0或1\n"),e("ol",[e("li",[t._v("如果value只有10位，执行setbit key 50 1，那么10-49都会自动补0")])])]),t._v(" "),e("li",[t._v("getbit key offset")]),t._v(" "),e("li",[t._v("bitcout key [start end]：获取指定范围值为1的个数")])]),t._v(" "),e("p",[t._v("应用：独立用户统计，1亿用户，每天大概有5千万人访问，使用set和bitmap的区别：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("数据类型")])]),t._v(" "),e("th",[e("strong",[t._v("每个userid占用空间")])]),t._v(" "),e("th",[e("strong",[t._v("需要存储的用户量")])]),t._v(" "),e("th",[e("strong",[t._v("全部内存量")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("set")]),t._v(" "),e("td",[t._v("32位（假设userid用的是整型）")]),t._v(" "),e("td",[t._v("50,000,000")]),t._v(" "),e("td",[t._v("32*50,000,000 = 200MB")])]),t._v(" "),e("tr",[e("td",[t._v("bitmap")]),t._v(" "),e("td",[t._v("1位")]),t._v(" "),e("td",[t._v("100,000,000")]),t._v(" "),e("td",[t._v("1*100,000,000 = 12.5M")])])])]),t._v(" "),e("p",[t._v("假如还是1亿用户，但是每天大概只有100万人访问")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("数据类型")])]),t._v(" "),e("th",[e("strong",[t._v("每个userid占用空间")])]),t._v(" "),e("th",[e("strong",[t._v("需要存储的用户量")])]),t._v(" "),e("th",[e("strong",[t._v("全部内存量")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("set")]),t._v(" "),e("td",[t._v("32位（假设userid用的是整型）")]),t._v(" "),e("td",[t._v("1,000,000")]),t._v(" "),e("td",[t._v("32*1,000,000 = 4MB")])]),t._v(" "),e("tr",[e("td",[t._v("bitmap")]),t._v(" "),e("td",[t._v("1位")]),t._v(" "),e("td",[t._v("100,000,000")]),t._v(" "),e("td",[t._v("1*100,000,000 = 12.5M")])])])]),t._v(" "),e("p",[t._v("可以使用用户表的id来决定每个用户所在的位，因为是独立用户访问（去重），所以不能用累加的方式")]),t._v(" "),e("h4",{attrs:{id:"_2-3-5-hyperloglog-极小空间完成独立数量统计"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-5-hyperloglog-极小空间完成独立数量统计"}},[t._v("#")]),t._v(" 2.3.5 HyperLogLog（极小空间完成独立数量统计）")]),t._v(" "),e("p",[t._v("底层是字符串，"),e("em",[t._v("原理是伯努利概率论相关的东西")])]),t._v(" "),e("p",[t._v("命令：")]),t._v(" "),e("ol",[e("li",[t._v("pfadd key element1 element2...：向hyperloglog添加元素")]),t._v(" "),e("li",[t._v("pfcount key：计算这个key的独立总数")]),t._v(" "),e("li",[t._v("pfmerge destkey sourcekey1 sourcekey1...：合并多个hyperloglog key到另外一个destkey")])]),t._v(" "),e("p",[t._v("比bitmap消耗内存量更小，100万个用户，大约只能消耗15KB\n缺点：")]),t._v(" "),e("ol",[e("li",[t._v("有一定的错误率：0.81%")]),t._v(" "),e("li",[t._v("无法知道具体的用户id")])]),t._v(" "),e("h4",{attrs:{id:"_2-3-6-geo-地理位置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-6-geo-地理位置"}},[t._v("#")]),t._v(" 2.3.6 geo（地理位置）")]),t._v(" "),e("p",[t._v("应用：摇一摇、附近的酒店")]),t._v(" "),e("h2",{attrs:{id:"_3-持久化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-持久化"}},[t._v("#")]),t._v(" 3 持久化")]),t._v(" "),e("p",[t._v("持久化的方式：")]),t._v(" "),e("ol",[e("li",[t._v("快照：MySQL Dump、Redis RDB")]),t._v(" "),e("li",[t._v("写日志：MySQL binlog、Redis AOF")])]),t._v(" "),e("h3",{attrs:{id:"_3-1-快照-rdb-redis-database"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-快照-rdb-redis-database"}},[t._v("#")]),t._v(" 3.1 快照 RDB（Redis DataBase）")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984625678-7161d45c-0ca9-46b2-8236-18791db67a35.png#height=324&id=r3IwB&name=16.png&originHeight=324&originWidth=861&originalType=binary&ratio=1&size=58903&status=done&style=none&width=861",alt:"16.png"}})]),t._v(" "),e("p",[e("em",[t._v("stop-writes-on-bgsave-error：如果等于 yes")])]),t._v(" "),e("p",[e("em",[t._v("假设 ：创建快照（硬盘上，产生一个新的rdb文件）需要 20s时间，redis主进程，在这20s内，会继续接受客户端命令，但是，就在这20s内，创建快照出错了，比如磁盘满了，那么redis会拒绝新的写入，也就是说，它认为，你当下，持久化数据出现了问题，你就不要再set了")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("strong",[t._v("命令")])]),t._v(" "),e("th",[e("strong",[t._v("save")])]),t._v(" "),e("th",[e("strong",[t._v("bgsave")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("IO类型")]),t._v(" "),e("td",[t._v("同步")]),t._v(" "),e("td",[t._v("异步")])]),t._v(" "),e("tr",[e("td",[t._v("阻塞")]),t._v(" "),e("td",[t._v("是")]),t._v(" "),e("td",[t._v("是（阻塞发生在fork）")])]),t._v(" "),e("tr",[e("td",[t._v("优点")]),t._v(" "),e("td",[t._v("不会消耗额外内存")]),t._v(" "),e("td",[t._v("不太阻塞redis")])])])]),t._v(" "),e("h3",{attrs:{id:"_3-2-日志-aof-append-only-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-日志-aof-append-only-file"}},[t._v("#")]),t._v(" 3.2 日志 AOF（Append Only File）")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984697200-2ca4d46f-fa96-492f-be21-5deed4bcca1a.png#height=297&id=S6IE7&name=17.png&originHeight=297&originWidth=1057&originalType=binary&ratio=1&size=61462&status=done&style=none&width=1057",alt:"17.png"}})]),t._v(" "),e("h4",{attrs:{id:"_3-2-1-aof重写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-aof重写"}},[t._v("#")]),t._v(" 3.2.1 AOF重写")]),t._v(" "),e("p",[t._v("aof重写：例如重写之前")]),t._v(" "),e("ul",[e("li",[t._v("set hello world")]),t._v(" "),e("li",[t._v("set hello java")]),t._v(" "),e("li",[t._v("set hello heee")])]),t._v(" "),e("p",[t._v("重写之后：set hello hehe，节约磁盘，加速数据恢复")]),t._v(" "),e("p",[e("strong",[t._v("AOF重写流程：")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1610984745118-f2e47fff-bae4-48a1-be7b-4e439a8c8fd0.png#height=356&id=h9EWq&name=18.png&originHeight=688&originWidth=1048&originalType=binary&ratio=1&size=78884&status=done&style=none&width=542",alt:"18.png"}})]),t._v(" "),e("ul",[e("li",[t._v("执行 aof 重写请求\n"),e("ul",[e("li",[t._v("如果当前进程正在执行 aof 重写，请求不执行并返回如下响应：ERR Background append only file rewriting already in process")]),t._v(" "),e("li",[t._v("如果当前正在执行 bgsave ，重写命令等待 bgsave 完成后执行 ，返回如下响应：Background append only file rewriting shceduled")])])]),t._v(" "),e("li",[t._v("父进程执行 fork 创建子进程，等同于bgsave过程")]),t._v(" "),e("li",[t._v("父进程 fork 操作完毕之后，依然响应其他命令，所有修改命令依然写入aof_buffer，并写入aof_rewrite_buffer中")]),t._v(" "),e("li",[t._v("子进程根据内存快照，按照命令合并规则写入到新的 aof 文件")]),t._v(" "),e("li",[t._v("新 aof 文件写入完成之后，子进程通知父进程：\n"),e("ul",[e("li",[t._v("父进程把 aof 重写缓冲区的数据写入 新的 aof 文件")]),t._v(" "),e("li",[t._v("使用 新 aof 文件替换 旧的 aof 文件")])])])]),t._v(" "),e("p",[e("strong",[t._v("AOF参数：")])]),t._v(" "),e("ol",[e("li",[t._v("appendonly：开启AOF")]),t._v(" "),e("li",[t._v("appendfilename：appendonly-${port}.aof")]),t._v(" "),e("li",[t._v("appendsync：建议everysec")]),t._v(" "),e("li",[t._v("dir：/bigdiskpath")]),t._v(" "),e("li",[t._v("no-appendfsync-on-rewrite：在进行aof重写的时候，是否需要执行正常的aof刷盘；设置成yes是不进行，这样可能会丢失些数据（"),e("em",[t._v("同时在执行bgrewriteaof操作和主进程写aof文件的操作，两者都会操作磁盘，而bgrewriteaof往往会涉及大量磁盘操作，这样就会造成主进程在写aof文件的时候出现阻塞的情形，现在no-appendfsync-on-rewrite参数出场了。如果该参数设置为no，是最安全的方式，不会丢失数据，但是要忍受阻塞的问题")]),t._v("）")]),t._v(" "),e("li",[t._v("auto-aof-rewrite-percentage")]),t._v(" "),e("li",[t._v("auto-aof-rewrite-min-save")])]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"title"}),e("p",[t._v("RDB默认是打开的，按照：900s/1change，300s/10change，60s/10000chang")]),t._v(" "),e("p",[t._v("AOF默认是关闭的")])]),e("h3",{attrs:{id:"_3-3-rdb-和-aof-比较"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-rdb-和-aof-比较"}},[t._v("#")]),t._v(" 3.3 RDB 和 AOF 比较")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th"),t._v(" "),e("th",[e("strong",[t._v("RDB")])]),t._v(" "),e("th",[e("strong",[t._v("AOF")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("恢复/启动优先级")]),t._v(" "),e("td",[t._v("低")]),t._v(" "),e("td",[t._v("高")])]),t._v(" "),e("tr",[e("td",[t._v("体积")]),t._v(" "),e("td",[t._v("小")]),t._v(" "),e("td",[t._v("大")])]),t._v(" "),e("tr",[e("td",[t._v("恢复速度")]),t._v(" "),e("td",[t._v("快")]),t._v(" "),e("td",[t._v("慢")])]),t._v(" "),e("tr",[e("td",[t._v("数据安全")]),t._v(" "),e("td",[t._v("丢数据")]),t._v(" "),e("td",[t._v("根据策略决定")])]),t._v(" "),e("tr",[e("td",[t._v("轻重")]),t._v(" "),e("td",[t._v("重")]),t._v(" "),e("td",[t._v("轻")])])])]),t._v(" "),e("p",[t._v("建议：关RDB，开AOF")]),t._v(" "),e("p",[e("em",[t._v("如果 Redis 同时使用 RDB 和 AOF 持久化，Redis 会优先使用 AOF 进行恢复数据")])]),t._v(" "),e("h3",{attrs:{id:"_3-4-常见问题与优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-常见问题与优化"}},[t._v("#")]),t._v(" 3.4 常见问题与优化")]),t._v(" "),e("h4",{attrs:{id:"_3-4-1-fork问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-fork问题"}},[t._v("#")]),t._v(" 3.4.1 fork问题")]),t._v(" "),e("ol",[e("li",[t._v("同步操作，会阻塞主线程")]),t._v(" "),e("li",[t._v("与内存量息息相关：内存越大，耗时越长")]),t._v(" "),e("li",[t._v("可以通过info stats命令查看最近一次fork的时长latest_fork_usec，可以对这个参数进行监控和告警")]),t._v(" "),e("li",[t._v("解决方案：\n"),e("ol",[e("li",[t._v("控制redis实例最大可用内存：maxmemory，小分片")]),t._v(" "),e("li",[t._v("监控latest_fork_usec")]),t._v(" "),e("li",[t._v("合理配置Linux内存分配策略：vm.overcommit_memory=1，当内存不太够时进行fork会报错")]),t._v(" "),e("li",[t._v("降低fork频率：减少bgsave、bgrewriteaof的执行")])])])]),t._v(" "),e("p",[e("em",[t._v("注：vm.overcommit_memory用来设置内存分配策略，有3个可选值0，1，2：")])]),t._v(" "),e("ul",[e("li",[t._v("0：表示内核将检查是否有足够的可用内存，如果有足够的可用内存，内存申请通过，否则申请失败，并把错误返回给应用进程")]),t._v(" "),e("li",[t._v("1：表示内核允许超量使用内存直到用完为止（redis建议配置成这个，能保证fork能最大程度成功）")]),t._v(" "),e("li",[t._v("2：表示内核绝不过量使用内存，内存申请不能超过系统的最大内存")])]),t._v(" "),e("h4",{attrs:{id:"_3-4-2-子进程开销和优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-子进程开销和优化"}},[t._v("#")]),t._v(" 3.4.2 子进程开销和优化")]),t._v(" "),e("p",[t._v("fork操作生成的子进程其实会和主进程共享内存，只有当主进程有写入或修改操作时，子线程会生成一个副本\n这就是为什么fork比较快")]),t._v(" "),e("h4",{attrs:{id:"_3-4-3-硬盘优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-3-硬盘优化"}},[t._v("#")]),t._v(" 3.4.3 硬盘优化")]),t._v(" "),e("ol",[e("li",[t._v("不要和高硬盘负载服务部署一起：存储服务、消息队列")]),t._v(" "),e("li",[t._v("no-appendfsync-on-rewirte设置成yes")]),t._v(" "),e("li",[t._v("根据写入量决定磁盘类型要不要使用SSD")]),t._v(" "),e("li",[t._v("单机多实例要控制好，共享资源实例之间的资源分配")])])])}),[],!1,null,null,null);e.default=a.exports}}]);