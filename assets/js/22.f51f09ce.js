(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{420:function(t,e,a){"use strict";a.r(e);var n=a(2),v=Object(n.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"_1-更新策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-更新策略"}},[t._v("#")]),t._v(" 1 更新策略")]),t._v(" "),e("h3",{attrs:{id:"_1-1-先更新缓存-再更新数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-先更新缓存-再更新数据库"}},[t._v("#")]),t._v(" 1.1 先更新缓存，再更新数据库")]),t._v(" "),e("p",[t._v("问题：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("更新缓存成功，更新数据库失败；")])]),t._v(" "),e("li",[e("p",[t._v("并发问题")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("时间")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程A")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程B")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("数据库")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("缓存")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存为v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")])])])])])]),t._v(" "),e("h3",{attrs:{id:"_1-2-先更新数据库-再更新缓存"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-先更新数据库-再更新缓存"}},[t._v("#")]),t._v(" 1.2 先更新数据库，再更新缓存")]),t._v(" "),e("p",[t._v("问题：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("数据库更新成功，缓存更新失败，在缓存失效之前都有问题")])]),t._v(" "),e("li",[e("p",[t._v("并发问题：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("时间")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程A")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程B")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("数据库")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("缓存")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存为v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")])])])])])]),t._v(" "),e("h2",{attrs:{id:"_2-删除策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-删除策略"}},[t._v("#")]),t._v(" 2 删除策略")]),t._v(" "),e("h3",{attrs:{id:"_2-1-先删除缓存-再更新数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-先删除缓存-再更新数据库"}},[t._v("#")]),t._v(" 2.1 先删除缓存，再更新数据库")]),t._v(" "),e("p",[t._v("问题：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("删除缓存成功，更新数据库失败（这不是什么大问题）")])]),t._v(" "),e("li",[e("p",[t._v("并发问题：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("时间")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程A")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程B")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("数据库")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("缓存")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("删除缓存v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("读取数据库v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("删除缓存(延时双删策略)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})])])])])]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),t._v(" data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    redis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("delKey")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    db"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateData")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这个时间不太好确定")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    redis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("delKey")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("要自行评估自己的项目的读数据业务逻辑的耗时。然后写数据的休眠时间则在读数据业务逻辑的耗时基础上，加几百ms即可；但是如果第二次删除缓存失败，还是会产生脏数据")]),t._v(" "),e("h3",{attrs:{id:"_2-2-先更新数据库-再删除缓存"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-先更新数据库-再删除缓存"}},[t._v("#")]),t._v(" 2.2 先更新数据库，再删除缓存")]),t._v(" "),e("p",[t._v("问题：")]),t._v(" "),e("ul",[e("li",[t._v("更新数据库成功，删除缓存失败，在缓存失效之前都有问题")]),t._v(" "),e("li",[t._v("并发问题：\n"),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("时间")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程A")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("线程B")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("数据库")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("缓存")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("0，缓存刚好失效")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("读取数据库v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新数据库为v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("删除缓存")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("更新缓存为v0")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("删除缓存(延时双删策略)")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("v1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})])])])])]),t._v(" "),e("h2",{attrs:{id:"_3-删除缓存失败-采用删除策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-删除缓存失败-采用删除策略"}},[t._v("#")]),t._v(" 3 删除缓存失败（采用删除策略）")]),t._v(" "),e("ul",[e("li",[t._v("2.1 与 2.2 延迟双删可能删除缓存失败")]),t._v(" "),e("li",[t._v("2.2 相对于 2.1 来说发生并发问题的可能性更低，因为刚好读缓存、写数据库、缓存失效三者并发；而且写数据库不太可能比读数据库慢")])]),t._v(" "),e("p",[t._v("删除策略还有问题，就是缓存击穿问题；可以考虑使用两级缓存来解决不一致问题；一级和二级失效的时间不一样，让读请求永远打不到数据库")]),t._v(" "),e("h3",{attrs:{id:"_3-1-第一种删除重试机制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-第一种删除重试机制"}},[t._v("#")]),t._v(" 3.1 第一种删除重试机制")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1611504175790-1ccf6400-655c-4cea-a9b1-7d6e41605470.png#align=left&display=inline&height=355&name=64.png&originHeight=710&originWidth=1042&size=262823&status=done&style=none&width=521",alt:"64.png"}})]),t._v(" "),e("p",[t._v("流程如下所示")]),t._v(" "),e("ul",[e("li",[t._v("更新数据库数据")]),t._v(" "),e("li",[t._v("缓存因为种种问题删除失败")]),t._v(" "),e("li",[t._v("将需要删除的key发送至消息队列")]),t._v(" "),e("li",[t._v("自己消费消息，获得需要删除的key")]),t._v(" "),e("li",[t._v("继续重试删除操作，直到成功")])]),t._v(" "),e("h3",{attrs:{id:"_3-2-第二种删除重试机制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-第二种删除重试机制"}},[t._v("#")]),t._v(" 3.2 第二种删除重试机制")]),t._v(" "),e("p",[t._v("上面方案有一个缺点，对业务线代码造成大量的侵入。于是有了方案二，在方案二中，启动一个订阅程序去订阅数据库的binlog，获得需要操作的数据。在应用程序中，另起一段程序，获得这个订阅程序传来的信息，进行删除缓存操作")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2021/png/375413/1611504477567-279552ae-e089-4525-b8ab-b8d520357212.png#align=left&display=inline&height=379&name=65.png&originHeight=505&originWidth=743&size=52288&status=done&style=none&width=557",alt:"65.png"}})]),t._v(" "),e("p",[t._v("流程如下图所示：")]),t._v(" "),e("ul",[e("li",[t._v("更新数据库数据")]),t._v(" "),e("li",[t._v("数据库会将操作信息写入binlog日志当中")]),t._v(" "),e("li",[t._v("订阅程序提取出所需要的数据以及key（订阅binlog程序在mysql中有现成的中间件叫canal）")]),t._v(" "),e("li",[t._v("另起一段非业务代码，获得该信息")]),t._v(" "),e("li",[t._v("尝试删除缓存操作，发现删除失败")]),t._v(" "),e("li",[t._v("将这些信息发送至消息队列")]),t._v(" "),e("li",[t._v("重新从消息队列中获得该数据，重试操作")])]),t._v(" "),e("h2",{attrs:{id:"_4-其他"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-其他"}},[t._v("#")]),t._v(" 4 其他")]),t._v(" "),e("h3",{attrs:{id:"_4-1-cache-aside-pattern"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-cache-aside-pattern"}},[t._v("#")]),t._v(" 4.1 Cache Aside Pattern")]),t._v(" "),e("p",[t._v("Cache Aside Pattern 是处理缓存一致性问题的一种模式，其实就是 2.2 的策略")]),t._v(" "),e("h3",{attrs:{id:"_4-2-read-write-through-pattern"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-read-write-through-pattern"}},[t._v("#")]),t._v(" 4.2 Read/Write Through Pattern")]),t._v(" "),e("p",[t._v("将缓存服务作为主要的存储，应用的所有读写请求都是直接与缓存服务打交道，而不管最后端的数据库了，数据库的数据由缓存服务来维护和更新。不过缓存中数据变更的时候是同步去更新数据库的，在应用的眼中只有缓存服务，流程就相当简单了：（LevelDB、RocksDB、TiDB ）")]),t._v(" "),e("ul",[e("li",[t._v("读取：应用要读数据和更新数据都直接访问缓存服务")]),t._v(" "),e("li",[t._v("更新：缓存服务同步的将数据更新到数据库")])]),t._v(" "),e("h3",{attrs:{id:"_4-3-write-behind-caching-pattern"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-write-behind-caching-pattern"}},[t._v("#")]),t._v(" 4.3 Write Behind Caching Pattern")]),t._v(" "),e("p",[t._v("是Read/Write Through模式的一个变种。区别就是Read/Write Through模式的缓存写数据库的时候是同步的，而Write Behind模式的缓存操作数据库是异步的，流程如下：")]),t._v(" "),e("ul",[e("li",[t._v("应用要读数据和更新数据都直接访问缓存服务")]),t._v(" "),e("li",[t._v("缓存服务异步的将数据更新到数据库（通过异步任务）")])])])}),[],!1,null,null,null);e.default=v.exports}}]);